function Y = Y_computation(q,dq,dq_r,ddq_r,params)

g = 9.81;

q1 = q(1);
q2 = q(2);
q3 = q(3);
q4 = q(4);

dq1 = dq(1);
dq2 = dq(2);
dq3 = dq(3);
dq4 = dq(4);

dq_r1 = dq_r(1);
dq_r2 = dq_r(2);
dq_r3 = dq_r(3);
dq_r4 = dq_r(4);

ddq_r1 = ddq_r(1);
ddq_r2 = ddq_r(2);
ddq_r3 = ddq_r(3);
ddq_r4 = ddq_r(4);

a1=params(1);
a2=params(2);
a3=params(3);
a4=params(4);

%% Build Regressor based on slides Gabiccini (notes to be written in LaTeX)
Y = [(a1^2*ddq_r1)/3, ddq_r1*((a2^2*(2*cos(q2)^2 - 1))/6 + a1^2 + a2^2/6 + a1*a2*cos(q2)) - dq1*dq_r2*((cos(q2)*sin(q2)*a2^2)/3 + (a1*sin(q2)*a2)/2) - dq2*dq_r1*((cos(q2)*sin(q2)*a2^2)/3 + (a1*sin(q2)*a2)/2), ddq_r1*((a2^2*cos(2*q2))/2 + (a3^2*cos(2*q2 + 2*q3))/6 + a1^2 + a2^2/2 + a3^2/6 + (a2*a3*cos(2*q2 + q3))/2 + a1*a3*cos(q2 + q3) + 2*a1*a2*cos(q2) + (a2*a3*cos(q3))/2) - dq_r1*(dq2*((sin(2*q2)*a2^2)/2 + (sin(2*q2 + q3)*a2*a3)/2 + a1*sin(q2)*a2 + (sin(2*q2 + 2*q3)*a3^2)/6 + (a1*sin(q2 + q3)*a3)/2) + (a3*dq3*(2*a3*sin(2*q2 + 2*q3) + 6*a1*sin(q2 + q3) + 3*a2*sin(q3) + 3*a2*sin(2*q2 + q3)))/12) - dq1*dq_r2*((sin(2*q2)*a2^2)/2 + (sin(2*q2 + q3)*a2*a3)/2 + a1*sin(q2)*a2 + (sin(2*q2 + 2*q3)*a3^2)/6 + (a1*sin(q2 + q3)*a3)/2) - (a3*dq1*dq_r3*(2*a3*sin(2*q2 + 2*q3) + 6*a1*sin(q2 + q3) + 3*a2*sin(q3) + 3*a2*sin(2*q2 + q3)))/12,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ddq_r1*((a4^2*cos(2*q2 + 2*q3 + 2*q4))/6 + a4^2/6) - dq_r1*((a4^2*dq2*sin(2*q2 + 2*q3 + 2*q4))/6 + (a4^2*dq3*sin(2*q2 + 2*q3 + 2*q4))/6 + (a4^2*dq4*sin(2*q2 + 2*q3 + 2*q4))/6) - (a4^2*dq1*dq_r2*sin(2*q2 + 2*q3 + 2*q4))/6 - (a4^2*dq1*dq_r3*sin(2*q2 + 2*q3 + 2*q4))/6 - (a4^2*dq1*dq_r4*sin(2*q2 + 2*q3 + 2*q4))/6;
    0,                                                                                             (a2^2*ddq_r2)/3 + dq1*dq_r1*((cos(q2)*sin(q2)*a2^2)/3 + (a1*sin(q2)*a2)/2) + (a2*g*cos(q2))/2,                                                                                                                                                                                                                                                                                                                       ddq_r2*(a2^2 + cos(q3)*a2*a3 + a3^2/3) + dq1*dq_r1*((sin(2*q2)*a2^2)/2 + (sin(2*q2 + q3)*a2*a3)/2 + a1*sin(q2)*a2 + (sin(2*q2 + 2*q3)*a3^2)/6 + (a1*sin(q2 + q3)*a3)/2) + (a3*g*cos(q2 + q3))/2 + (a3*ddq_r3*(2*a3 + 3*a2*cos(q3)))/6 + a2*g*cos(q2) - (a2*a3*dq_r3*sin(q3)*(dq2 + dq3))/2 - (a2*a3*dq3*dq_r2*sin(q3))/2,                                                                                                                                                                          a1^2*ddq_r2 - a1*g + a1^2*ddq_r3 + a1^2*ddq_r4 + (a4^2*ddq_r2)/3 + (a4^2*ddq_r3)/3 + (a4^2*ddq_r4)/3 + (a4*g*cos(q2 + q3 + q4))/2 + a1*a3*ddq_r4*cos(q2 + q3) - (a2*a4*ddq_r3*cos(q3 + q4))/2 - (a2*a4*ddq_r4*cos(q3 + q4))/2 + (a4^2*dq1*dq_r1*sin(2*q2 + 2*q3 + 2*q4))/6 + a1*a2*ddq_r3*cos(q2) + a1*a2*ddq_r4*cos(q2) - (a3*a4*ddq_r4*cos(q4))/2 - a1*a4*ddq_r2*cos(q2 + q3 + q4) - a1*a4*ddq_r3*cos(q2 + q3 + q4) - a1*a4*ddq_r4*cos(q2 + q3 + q4) + (a1*a4*dq2*dq_r2*sin(q2 + q3 + q4))/2 + (a1*a4*dq2*dq_r3*sin(q2 + q3 + q4))/2 + (a1*a4*dq3*dq_r2*sin(q2 + q3 + q4))/2 + (a1*a4*dq2*dq_r4*sin(q2 + q3 + q4))/2 + (a1*a4*dq3*dq_r3*sin(q2 + q3 + q4))/2 + (a1*a4*dq4*dq_r2*sin(q2 + q3 + q4))/2 + (a1*a4*dq3*dq_r4*sin(q2 + q3 + q4))/2 + (a1*a4*dq4*dq_r3*sin(q2 + q3 + q4))/2 + (a1*a4*dq4*dq_r4*sin(q2 + q3 + q4))/2 + a1*a3*dq4*dq_r4*sin(q2 + q3) + (a2*a4*dq3*dq_r3*sin(q3 + q4))/2 + (a2*a4*dq3*dq_r4*sin(q3 + q4))/2 + (a2*a4*dq4*dq_r3*sin(q3 + q4))/2 + (a2*a4*dq4*dq_r4*sin(q3 + q4))/2 + a1*a2*dq3*dq_r3*sin(q2) + a1*a2*dq3*dq_r4*sin(q2) + a1*a2*dq4*dq_r3*sin(q2) + a1*a2*dq4*dq_r4*sin(q2) + (a3*a4*dq4*dq_r4*sin(q4))/2;
    0,                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                                                                                 (a3*(4*a3*ddq_r2 + 4*a3*ddq_r3 + 6*g*cos(q2 + q3) + 6*a2*ddq_r2*cos(q3) + 6*a1*dq1*dq_r1*sin(q2 + q3) + 3*a2*dq1*dq_r1*sin(q3) + 6*a2*dq2*dq_r2*sin(q3) + 3*a2*dq1*dq_r1*sin(2*q2 + q3) + 2*a3*dq1*dq_r1*sin(2*q2 + 2*q3)))/12, a1^2*ddq_r2 - a1*g + a1^2*ddq_r3 + a1^2*ddq_r4 + a2^2*ddq_r3 + a2^2*ddq_r4 + (a4^2*ddq_r2)/3 + (a4^2*ddq_r3)/3 + (a4^2*ddq_r4)/3 + (a4*g*cos(q2 + q3 + q4))/2 - a2*g*cos(q2) + a1*a3*ddq_r4*cos(q2 + q3) - (a2*a4*ddq_r2*cos(q3 + q4))/2 - a2*a4*ddq_r3*cos(q3 + q4) - a2*a4*ddq_r4*cos(q3 + q4) + (a4^2*dq1*dq_r1*sin(2*q2 + 2*q3 + 2*q4))/6 + a1*a2*ddq_r2*cos(q2) + 2*a1*a2*ddq_r3*cos(q2) + 2*a1*a2*ddq_r4*cos(q2) + a2*a3*ddq_r4*cos(q3) - (a3*a4*ddq_r4*cos(q4))/2 - a1*a4*ddq_r2*cos(q2 + q3 + q4) - a1*a4*ddq_r3*cos(q2 + q3 + q4) - a1*a4*ddq_r4*cos(q2 + q3 + q4) + (a1*a4*dq2*dq_r2*sin(q2 + q3 + q4))/2 + (a1*a4*dq2*dq_r3*sin(q2 + q3 + q4))/2 + (a1*a4*dq3*dq_r2*sin(q2 + q3 + q4))/2 + (a1*a4*dq2*dq_r4*sin(q2 + q3 + q4))/2 + (a1*a4*dq3*dq_r3*sin(q2 + q3 + q4))/2 + (a1*a4*dq4*dq_r2*sin(q2 + q3 + q4))/2 + (a1*a4*dq3*dq_r4*sin(q2 + q3 + q4))/2 + (a1*a4*dq4*dq_r3*sin(q2 + q3 + q4))/2 + (a1*a4*dq4*dq_r4*sin(q2 + q3 + q4))/2 + a1*a3*dq4*dq_r4*sin(q2 + q3) + (a2*a4*dq3*dq_r3*sin(q3 + q4))/2 + (a2*a4*dq3*dq_r4*sin(q3 + q4))/2 + (a2*a4*dq4*dq_r3*sin(q3 + q4))/2 + (a2*a4*dq4*dq_r4*sin(q3 + q4))/2 - a1*a2*dq2*dq_r2*sin(q2) - a1*a2*dq2*dq_r3*sin(q2) - a1*a2*dq3*dq_r2*sin(q2) - a1*a2*dq2*dq_r4*sin(q2) - a1*a2*dq4*dq_r2*sin(q2) + a2*a3*dq4*dq_r4*sin(q3) + (a3*a4*dq4*dq_r4*sin(q4))/2;
    0,                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0,                                         (ddq_r2*(6*a1^2 + 2*a4^2 - 6*a1*a4*cos(q2 + q3 + q4) + 6*a1*a3*cos(q2 + q3) - 3*a2*a4*cos(q3 + q4) + 6*a1*a2*cos(q2) - 3*a3*a4*cos(q4)))/6 + (ddq_r3*(6*a1^2 + 12*cos(q2)*a1*a2 - 6*cos(q2 + q3 + q4)*a1*a4 + 6*a3*cos(q2 + q3)*a1 + 6*a2^2 - 6*cos(q3 + q4)*a2*a4 + 6*a3*cos(q3)*a2 + 2*a4^2 - 3*a3*cos(q4)*a4))/6 - dq_r4*((dq3*(6*a2*a3*sin(q3) - 3*a1*a4*sin(q2 + q3 + q4) + 6*a1*a3*sin(q2 + q3) - 3*a2*a4*sin(q3 + q4)))/6 + (a1*dq2*(2*a3*sin(q2 + q3) + 2*a2*sin(q2) - a4*sin(q2 + q3 + q4)))/2 - (a4*dq4*(a2*sin(q3 + q4) + a3*sin(q4) + a1*sin(q2 + q3 + q4)))/2) - g*(a1 + a3*cos(q2 + q3) + a2*cos(q2) - (a4*cos(q2 + q3 + q4))/2) - (dq_r3*(2*a1*a3*dq2*sin(q2 + q3) + 2*a1*a3*dq3*sin(q2 + q3) + 2*a1*a3*dq4*sin(q2 + q3) - a2*a4*dq3*sin(q3 + q4) - a2*a4*dq4*sin(q3 + q4) + 2*a1*a2*dq2*sin(q2) + 2*a2*a3*dq3*sin(q3) + 2*a2*a3*dq4*sin(q3) - a1*a4*dq2*sin(q2 + q3 + q4) - a1*a4*dq3*sin(q2 + q3 + q4) - a1*a4*dq4*sin(q2 + q3 + q4)))/2 + (ddq_r4*(3*a1^2 + 6*cos(q2)*a1*a2 + 6*cos(q2 + q3)*a1*a3 - 3*cos(q2 + q3 + q4)*a1*a4 + 3*a2^2 + 6*cos(q3)*a2*a3 - 3*cos(q3 + q4)*a2*a4 + 3*a3^2 - 3*cos(q4)*a3*a4 + a4^2))/3 - (a1*dq_r2*(2*a3*sin(q2 + q3) + 2*a2*sin(q2) - a4*sin(q2 + q3 + q4))*(dq2 + dq3 + dq4))/2 + (a4^2*dq1*dq_r1*sin(2*q2 + 2*q3 + 2*q4))/6];

end






